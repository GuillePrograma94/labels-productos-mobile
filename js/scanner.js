/**
 * Esc√°ner de c√≥digos de barras para la aplicaci√≥n m√≥vil
 * Utiliza la API de getUserMedia y ZXing para detectar c√≥digos
 */

class BarcodeScanner {
    constructor() {
        this.isScanning = false;
        this.stream = null;
        this.video = null;
        this.codeReader = null;
        this.currentCamera = 'environment'; // 'user' o 'environment'
        this.hasFlash = false;
        this.flashEnabled = false;
        
        // Elementos DOM
        this.elements = {};
        
        // Inicializar ZXing
        this.initializeZXing();
    }

    /**
     * Inicializa la librer√≠a ZXing
     */
    async initializeZXing() {
        try {
            // Cargar ZXing din√°micamente
            if (!window.ZXing) {
                await this.loadZXingLibrary();
            }
            
            // Configurar hints para optimizar lectura de c√≥digos alfanum√©ricos
            const hints = new Map();
            const formats = [
                ZXing.BarcodeFormat.CODE_128,  // Principal para c√≥digos alfanum√©ricos
                ZXing.BarcodeFormat.CODE_39,   // Alternativo alfanum√©rico
                ZXing.BarcodeFormat.EAN_13,    // Para c√≥digos de barras est√°ndar
                ZXing.BarcodeFormat.EAN_8      // Para c√≥digos cortos
            ];
            hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
            hints.set(ZXing.DecodeHintType.TRY_HARDER, true);  // Mejor precisi√≥n
            hints.set(ZXing.DecodeHintType.ASSUME_GS1, false); // No asumir formato GS1
            
            this.codeReader = new ZXing.BrowserMultiFormatReader(hints);
            console.log('‚úÖ ZXing inicializado con optimizaciones para Code128');
        } catch (error) {
            console.error('‚ùå Error al inicializar ZXing:', error);
        }
    }

    /**
     * Carga la librer√≠a ZXing din√°micamente
     */
    loadZXingLibrary() {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/@zxing/library@latest/umd/index.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    /**
     * Inicializa los elementos DOM
     */
    initializeElements() {
        this.elements = {
            scannerModal: document.getElementById('scannerModal'),
            closeScannerBtn: document.getElementById('closeScannerBtn'),
            scannerVideo: document.getElementById('scannerVideo'),
            scannerResult: document.getElementById('scannerResult'),
            detectedCode: document.getElementById('detectedCode'),
            searchDetectedBtn: document.getElementById('searchDetectedBtn'),
            capturePhotoBtn: document.getElementById('capturePhotoBtn')
        };
    }

    /**
     * Vincula los eventos
     */
    bindEvents() {
        // Cerrar modal
        this.elements.closeScannerBtn.addEventListener('click', () => this.closeScanner());
        
        // Buscar c√≥digo detectado
        this.elements.searchDetectedBtn.addEventListener('click', () => this.searchDetectedCode());
        
        // Hacer foto manual
        this.elements.capturePhotoBtn.addEventListener('click', () => this.captureAndDecode());
        
        // Cerrar modal al hacer clic fuera
        this.elements.scannerModal.addEventListener('click', (e) => {
            if (e.target === this.elements.scannerModal) {
                this.closeScanner();
            }
        });
    }

    /**
     * Abre el esc√°ner
     */
    async openScanner() {
        try {
            // Inicializar elementos si no est√°n inicializados
            if (!this.elements.scannerModal) {
                this.initializeElements();
                this.bindEvents();
            }

            // Verificar soporte de c√°mara
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('Tu navegador no soporta acceso a la c√°mara');
            }

            // Mostrar modal
            this.elements.scannerModal.style.display = 'flex';
            
            // Ocultar resultado anterior
            this.elements.scannerResult.style.display = 'none';
            
            // Iniciar c√°mara
            await this.startCamera();
            
            // Iniciar escaneo
            this.startScanning();
            
            window.ui.showToast('Esc√°ner iniciado', 'success');

        } catch (error) {
            console.error('Error al abrir esc√°ner:', error);
            window.ui.showToast('Error: ' + error.message, 'error');
            this.closeScanner();
        }
    }

    /**
     * Inicia la c√°mara
     */
    async startCamera() {
        try {
            // Detener stream anterior si existe
            if (this.stream) {
                this.stopCamera();
            }

            // Configurar constraints con alta resoluci√≥n preferida
            const constraints = {
                video: {
                    facingMode: this.currentCamera,
                    width: { ideal: 1920, min: 640 },     // Full HD preferido, m√≠n 640
                    height: { ideal: 1080, min: 480 },    // Full HD preferido, m√≠n 480
                    focusMode: { ideal: 'continuous' },   // Autofocus continuo si disponible
                    zoom: { ideal: 1.0 }                  // Sin zoom por defecto
                }
            };

            // Obtener stream de la c√°mara
            this.stream = await navigator.mediaDevices.getUserMedia(constraints);
            
            // Asignar stream al video
            this.elements.scannerVideo.srcObject = this.stream;
            
            console.log('‚úÖ C√°mara iniciada');

        } catch (error) {
            console.error('Error al iniciar c√°mara:', error);
            
            if (error.name === 'NotAllowedError') {
                throw new Error('Permiso de c√°mara denegado. Permite el acceso a la c√°mara.');
            } else if (error.name === 'NotFoundError') {
                throw new Error('No se encontr√≥ ninguna c√°mara en el dispositivo.');
            } else {
                throw new Error('Error al acceder a la c√°mara: ' + error.message);
            }
        }
    }

    /**
     * Detiene la c√°mara
     */
    stopCamera() {
        if (this.stream) {
            this.stream.getTracks().forEach(track => track.stop());
            this.stream = null;
        }
        
        if (this.elements.scannerVideo) {
            this.elements.scannerVideo.srcObject = null;
        }
    }

    /**
     * Inicia el escaneo de c√≥digos
     */
    startScanning() {
        if (!this.codeReader || this.isScanning) return;

        this.isScanning = true;
        
        // Usar ZXing para detectar c√≥digos
        this.codeReader.decodeFromVideoDevice(
            undefined, // deviceId (undefined = usar el stream actual)
            this.elements.scannerVideo,
            (result, error) => {
                if (result) {
                    // C√≥digo detectado
                    this.onCodeDetected(result.text);
                }
                
                if (error && error.name !== 'NotFoundException') {
                    console.warn('Error de escaneo:', error);
                }
            }
        );
    }

    /**
     * Detiene el escaneo
     */
    stopScanning() {
        if (this.codeReader && this.isScanning) {
            this.codeReader.reset();
            this.isScanning = false;
        }
    }

    /**
     * Maneja la detecci√≥n de un c√≥digo
     */
    onCodeDetected(code) {
        console.log('üéØ C√≥digo detectado:', code);
        
        // Detener escaneo
        this.stopScanning();
        
        // Mostrar resultado
        this.elements.detectedCode.textContent = code;
        this.elements.scannerResult.style.display = 'block';
        
        // Vibraci√≥n si est√° disponible
        if (navigator.vibrate) {
            navigator.vibrate(200);
        }
        
        // Sonido de √©xito (opcional)
        this.playSuccessSound();
        
        window.ui.showToast('¬°C√≥digo detectado!', 'success');
        
        // B√∫squeda autom√°tica del c√≥digo detectado
        setTimeout(() => {
            this.searchDetectedCode();
        }, 1000); // Esperar 1 segundo para que el usuario vea el c√≥digo detectado
    }

    /**
     * Reproduce sonido de √©xito
     */
    playSuccessSound() {
        try {
            // Crear un sonido simple usando Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        } catch (error) {
            // Silenciar errores de audio
        }
    }

    /**
     * Busca el c√≥digo detectado y a√±ade autom√°ticamente si es √∫nico (B√öSQUEDA EXACTA desde esc√°ner)
     */
    async searchDetectedCode() {
        const code = this.elements.detectedCode.textContent;
        if (code) {
            // Cerrar esc√°ner
            this.closeScanner();
            
            // Buscar productos con este c√≥digo espec√≠fico (B√öSQUEDA EXACTA)
            try {
                console.log('üéØ B√∫squeda EXACTA desde esc√°ner:', code);
                const results = await window.storageManager.searchProducts(code, '', 10, true);
                
                if (results.length === 1) {
                    // Si hay exactamente un producto, a√±adirlo autom√°ticamente
                    const product = results[0];
                    await window.ui.addProductToList(product.codigo);
                    window.ui.showToast(`‚úÖ ${product.descripcion} a√±adido autom√°ticamente`, 'success');
                } else if (results.length > 1) {
                    // Si hay m√∫ltiples productos, mostrar resultados para que el usuario elija
                    window.ui.elements.codeInput.value = code;
                    window.ui.performSmartSearch();
                    window.ui.showToast(`üîç ${results.length} productos encontrados. Selecciona el correcto.`, 'info');
                } else {
                    // Si no se encuentra el producto
                    window.ui.elements.codeInput.value = code;
                    window.ui.showToast(`‚ùå No se encontr√≥ producto con c√≥digo ${code}`, 'warning');
                }
            } catch (error) {
                console.error('Error al buscar c√≥digo detectado:', error);
                // Fallback: usar b√∫squeda normal
                if (window.ui) {
                    window.ui.elements.codeInput.value = code;
                    window.ui.performSmartSearch();
                }
            }
        }
    }

    /**
     * Cierra el esc√°ner
     */
    closeScanner() {
        // Detener escaneo y c√°mara
        this.stopScanning();
        this.stopCamera();
        
        // Ocultar modal
        if (this.elements.scannerModal) {
            this.elements.scannerModal.style.display = 'none';
        }
        
        // Reset flash
        this.flashEnabled = false;
        
        console.log('üì∑ Esc√°ner cerrado');
    }

    /**
     * Captura una foto del video actual y fuerza la decodificaci√≥n
     */
    async captureAndDecode() {
        try {
            if (!this.elements.scannerVideo || !this.codeReader) {
                console.error('‚ùå Video o CodeReader no disponible');
                return;
            }

            console.log('üì∏ Capturando foto para decodificaci√≥n manual...');
            
            // Cambiar texto del bot√≥n temporalmente
            const originalText = this.elements.capturePhotoBtn.textContent;
            this.elements.capturePhotoBtn.textContent = '‚è≥ Procesando...';
            this.elements.capturePhotoBtn.disabled = true;

            // Crear canvas para capturar el frame actual del video
            const canvas = document.createElement('canvas');
            const video = this.elements.scannerVideo;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convertir canvas a blob
            canvas.toBlob(async (blob) => {
                try {
                    // Decodificar usando ZXing
                    const result = await this.codeReader.decodeFromImageElement(canvas);
                    
                    if (result && result.text) {
                        console.log('‚úÖ C√≥digo detectado manualmente:', result.text);
                        this.onCodeDetected(result.text);
                    } else {
                        console.log('‚ùå No se detect√≥ ning√∫n c√≥digo en la imagen');
                        this.showTemporaryMessage('No se detect√≥ c√≥digo. Intenta de nuevo.');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è No se pudo decodificar:', error);
                    this.showTemporaryMessage('No se detect√≥ c√≥digo. Aseg√∫rate de que est√© dentro del marco.');
                } finally {
                    // Restaurar bot√≥n
                    this.elements.capturePhotoBtn.textContent = originalText;
                    this.elements.capturePhotoBtn.disabled = false;
                }
            }, 'image/png');

        } catch (error) {
            console.error('‚ùå Error al capturar foto:', error);
            this.elements.capturePhotoBtn.textContent = 'üì∑ Hacer Foto';
            this.elements.capturePhotoBtn.disabled = false;
            this.showTemporaryMessage('Error al procesar la foto');
        }
    }

    /**
     * Muestra un mensaje temporal en las instrucciones del scanner
     */
    showTemporaryMessage(message) {
        const instructions = document.querySelector('.scanner-instructions');
        if (instructions) {
            const originalText = instructions.textContent;
            instructions.textContent = message;
            instructions.style.color = '#ff6b6b';
            
            setTimeout(() => {
                instructions.textContent = originalText;
                instructions.style.color = '';
            }, 3000);
        }
    }
}

// Instancia global del esc√°ner
window.barcodeScanner = new BarcodeScanner();
